#!/usr/bin/env bash
set -euo pipefail
TEST=${1:-ON}
# Configure
if [ "$TEST" = "ON" ]; then 
BUILD_DIR=build
else 
BUILD_DIR=build-pi
TOOLCHAIN=toolchain-rpi4.cmake
fi

cmake -S . -B $BUILD_DIR \
        -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN \
        -DBUILD_TESTS=$TEST \
        -DCMAKE_BUILD_TYPE=Release
# Build
cmake --build $BUILD_DIR -j"$(nproc)"

# Run tests
if [ "$TEST" = "ON" ]; then
    ctest --test-dir $BUILD_DIR --output-on-failure
fi